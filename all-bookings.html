<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>HomeGlitz ‚Äî All Bookings</title>
  <link rel="icon" type="image/png" href="https://raw.githubusercontent.com/Levinders/homeglitz/refs/heads/main/64%C3%9764pxlogo.png" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css" />
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700&display=swap" rel="stylesheet">

  <style>
    :root {
      --primary: #0F72B4;
      --primary-light: #f5faff;
      --text: #222;
      --muted: #6c757d;
      --panel: #fff;
      --border: #e4e9ef;
      --radius: 12px;
      --shadow: 0 6px 20px rgba(15,114,180,0.1);
      --transition: 0.3s ease;
    }

    * { box-sizing: border-box; font-family: 'Montserrat', sans-serif; }
    html, body { margin: 0; padding: 0; overflow-x: hidden; }
    body { display: flex; min-height: 100vh; background: var(--primary-light); color: var(--text); }

    /* === SIDEBAR (exact from Create New) === */
    .sidebar {
      position: fixed; left: 0; top: 0; bottom: 0;
      width: 250px; background: var(--panel); border-right: 1px solid var(--border);
      box-shadow: var(--shadow); display: flex; flex-direction: column;
      padding: 20px 0; overflow-y: auto; z-index: 2000;
      transition: left var(--transition); /* added for smooth mobile slide */
    }
    .sidebar .brand { display: flex; align-items: center; justify-content: center; margin-bottom: 30px; }
    .sidebar .brand img { height: 48px; transition: all var(--transition); }
    .nav-links { list-style: none; padding: 0; margin: 0; }
    .nav-item { position: relative; }
    .nav-links li a { display: flex; align-items: center; gap: 12px; padding: 14px 22px; color: var(--muted); font-weight: 500; text-decoration: none; transition: all var(--transition); }
    .nav-links li a:hover, .nav-links li a.active { background: var(--primary-light); color: var(--primary); border-left: 4px solid var(--primary); }
    .sub-menu { display: none; flex-direction: column; margin-left: 40px; }
    .sub-menu a { font-size: 14px; color: var(--muted); padding: 8px 0; transition: 0.2s; }
    .sub-menu a:hover { color: var(--primary); }
    .nav-item.open .sub-menu { display: flex; }

    /* === TOPBAR (exact) === */
    .topbar {
      height: 60px; background: var(--panel); border-bottom: 1px solid var(--border);
      display: flex; align-items: center; justify-content: space-between;
      padding: 0 25px; box-shadow: var(--shadow);
      position: fixed; top: 0; left: 250px; right: 0; z-index: 1000;
    }
    .menu-toggle { background: none; border: none; font-size: 20px; color: var(--primary); cursor: pointer; }
    .topbar-right { display: flex; align-items: center; gap: 20px; color: var(--muted); }

    /* === MAIN === */
    main { flex: 1; margin-left: 250px; padding: 100px 40px 40px; background: var(--primary-light); }

    /* Card becomes a column layout so footer can be fixed at bottom of card */
    .card {
      background: var(--panel); border-radius: var(--radius); box-shadow: var(--shadow);
      border: 1px solid var(--border); padding: 0; overflow: hidden;
      display: flex; flex-direction: column;
      /* Fill viewport height below topbar with some breathing room */
      height: calc(100vh - 120px);
    }

    /* Sticky header area inside card */
    .card__header {
      background: var(--panel);
      border-bottom: 1px solid var(--border);
      z-index: 5;
      padding: 16px 20px;
    }

    h2.card__title {
      font-size: 22px; font-weight: 700; color: var(--primary);
      display: flex; align-items: center; gap: 10px; margin: 0 0 12px 0;
    }

    /* Filters row (title + filters on the same horizontal) */
    .filters {
      display: grid;
      grid-template-columns: 0.2fr 0.2fr 0.2fr 0.2fr auto;
      gap: 10px;
      align-items: center;
    }
    .filters .field {
      display: flex; align-items: center; gap: 8px;
      border: 1px solid var(--border); border-radius: 10px;
      padding: 8px 12px; background: #fdfdfd;
    }
    .filters .field input, .filters .field select, .filters .field button {
      border: none; outline: none; background: transparent; font-size: 14px; flex: 1;
    }
    .filters .btn-clear {
      border: none; border-radius: 10px; padding: 10px 16px;
      background: #f1f3f5; color: var(--muted); font-weight: 600;
      cursor: pointer; transition: var(--transition);
    }
    .filters .btn-clear:hover { background: #e9ecef; }

    /* Table area scrolls (both axes) with sticky header */
    .table-wrap {
      flex: 1 1 auto;
      overflow: auto;               /* vertical + horizontal scroll */
      border-top: 1px solid var(--border);
      background: #fff;
      max-height: 85vh;
    }

    table { width: 100%; border-collapse: collapse; min-width: 500px; }
    thead th {
      position: sticky; top: 0;
      background: var(--primary); color: #fff; z-index: 2; font-size: 14px;
      white-space: nowrap;
    }
    th, td {
      padding: 12px 12px; font-size: 13px; text-align: left;
      border-bottom: 1px solid var(--border); vertical-align: middle;
    }
    tbody tr:hover { background: var(--primary-light); cursor: pointer; }
    td.cell-actions { cursor: default; }

    /* Property name cell: show first 3 words + ellipsis, full on hover via title */
    .prop-trunc {
      max-width: 280px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
      display: inline-block;
    }

    /* Inline status select */
    select.status-select {
      border: 1px solid var(--border);
      border-radius: 6px;
      padding: 6px 8px;
      font-size: 13px;
      background: #f9fbfd;
      color: #000;         /* keep readable on all devices */
      cursor: pointer;
    }
    tr.flash { background: #e9f7ff !important; transition: background 0.5s ease; }

    /* Card footer (fixed at bottom of card) */
    .card__footer {
      border-top: 1px solid var(--border);
      background: var(--panel);
      padding: 10px 16px;
      display: flex; align-items: center; justify-content: space-between;
      flex: 0 0 auto;
    }
    .pagination {
      display: flex; align-items: center; gap: 10px;
    }
    .pagination .btn {
      border: none; border-radius: 8px; padding: 8px 14px; font-weight: 400; cursor: pointer; font-size: 12px; transition: var(--transition);
      background: #f1f3f5; color: var(--muted);
    }
    .pagination .btn:hover { background: #e9ecef; }
    .pagination .btn[disabled] { opacity: .5; cursor: not-allowed; }
    .page-indicator { color: var(--muted); font-weight: 400; font-size: 12px;}

    /* Drawer (details panel) */
    .drawer-overlay {
      position: fixed; inset: 0;
      background: rgba(0,0,0,0.25);
      opacity: 0; visibility: hidden; transition: opacity 0.25s ease; z-index: 3000; /* faster */
      display: none; /* default off */
    }
    .drawer-overlay.active { opacity: 1; visibility: visible; display: block; }
    .drawer {
      position: fixed; top: 60px; right: 0; bottom: 0; width: min(560px, 100%);
      background: var(--panel); border-left: 1px solid var(--border);
      box-shadow: -10px 0 30px rgba(0,0,0,.08);
      transform: translateX(100%); transition: transform 0.25s ease; z-index: 3100; /* faster */
      display: flex; flex-direction: column;
    }
    .drawer.active { transform: translateX(0); }
    .drawer__head {
      padding: 16px 20px; border-bottom: 1px solid var(--border);
      display: flex; justify-content: space-between; align-items: center;
      position: sticky; top: 0; background: var(--panel); z-index: 1;
    }
    .drawer__title { font-weight: 700; color: var(--primary); display: flex; align-items: center; gap: 10px; }
    .drawer__body { padding: 20px; overflow: auto; }
    .drawer__grid { display: grid; grid-template-columns: 1fr 1fr; gap: 14px; }
    .group { display: flex; flex-direction: column; gap: 8px; }
    .group label { font-weight: 600; font-size: 13px; color: var(--primary); display: flex; align-items: center; gap: 8px; }
    .group input, .group select, .group textarea {
      border: 1px solid var(--border); border-radius: 10px; padding: 10px 12px; font-size: 12px; background: #fdfdfd; outline: none;
    }
    .section-title { font-weight: 700; color: var(--text); margin: 8px 0; border-bottom: 1px solid #eef2f6; padding-bottom: 6px; }
    .b2b-badges { display: flex; gap: 10px; }
    .badge { flex: 1; text-align: center; padding: 8px 10px; border-radius: 18px; border: 1px solid rgba(15,114,180,0.25); background: rgba(15,114,180,0.08); color: var(--primary); font-weight: 600; cursor: pointer; }
    .badge.active { background: var(--primary); color: #fff; box-shadow: 0 0 8px rgba(15,114,180,0.3); }
    .drawer__footer {
      border-top: 1px solid var(--border); padding: 14px 20px; display: flex; justify-content: flex-end; gap: 10px;
      position: sticky; bottom: 0; background: var(--panel);
    }
    .btn { border: none; border-radius: 8px; padding: 12px 22px; font-weight: 600; cursor: pointer; font-size: 14px; transition: var(--transition); }
    .btn-primary { background: var(--primary); color: #fff; box-shadow: 0 4px 10px rgba(15,114,180,0.2); }
    .btn-primary:hover { background: #0d5f95; transform: translateY(-1px); }
    .btn-light { background: #f1f3f5; color: var(--muted); }
    .btn-light:hover { background: #e9ecef; }

    /* Toast + Loader (same visuals as Create New) */
    .hz-toast {
      position: fixed; bottom: 24px; right: 24px;
      background: #0F72B4; color: #fff; padding: 12px 16px;
      border-radius: 10px; font-weight: 600; box-shadow: 0 10px 24px rgba(15,114,180,.25);
      opacity: 0; transform: translateY(16px); transition: .3s ease; z-index: 5000;
    }
    .hz-toast.show { opacity: 1; transform: translateY(0); }
    .hz-loader {
      position: fixed; inset: 0; background: rgba(0,0,0,.25);
      display: flex; align-items: center; justify-content: center;
      opacity: 0; visibility: hidden; transition: opacity .15s ease; z-index: 4000;
    }
    .hz-loader.active { opacity: 1; visibility: visible; }
    .hz-loader .box {
      background: #fff; border: 1px solid #e4e9ef; box-shadow: 0 10px 30px rgba(0,0,0,.08);
      padding: 18px 22px; border-radius: 12px; color: #222; font-weight: 600; display: flex; align-items: center; gap: 12px;
    }
    .hz-loader .spin { width: 18px; height: 18px; border-radius: 50%; border: 2px solid rgba(15,114,180,.2); border-top-color: #0F72B4; animation: hzspin 1s linear infinite; }
    @keyframes hzspin { to { transform: rotate(360deg); } }

    /* ===== üì± MOBILE ONLY ===== */
    @media (max-width: 900px) {
      /* Sidebar + Overlay for mobile nav */
      .sidebar { left: -250px; }
      .sidebar.open { left: 0; }
      .overlay.active {
        display: block;
        position: fixed;
        inset: 0;
        background: rgba(0,0,0,0.25);
        z-index: 1500;
      }

      /* Layout adjustments */
      .topbar { left: 0; right: 0; padding: 0 15px; }
      main { margin-left: 0; padding: 100px 10px 40px; }
      .filters { grid-template-columns: 1fr 1fr; gap: 8px; }
      .filters .field { padding: 6px 10px; font-size: 13px; }
      .table-wrap { overflow-x: auto; border-radius: 10px; }
      table { min-width: 800px; }
      .card__footer { flex-direction: column; align-items: center; gap: 8px; padding: 12px; }
      .pagination { justify-content: center; }
      .page-indicator { font-size: 13px; }

      /* Drawer as bottom sheet (fast 0.25s) */
      .drawer {
        width: 100%;
        left: 0;
        right: 0;
        bottom: 0;
        top: auto;
        border-radius: 16px 16px 0 0;
        border-left: none;
        border-top: 1px solid var(--border);
        transform: translateY(100%);
        transition: transform 0.25s ease; /* fast */
      }
      .drawer.active {
        transform: translateY(0);
      }

      .drawer__body { padding: 14px; max-height: 70vh; overflow-y: auto; }
      .drawer__grid { grid-template-columns: 1fr; gap: 10px; }
      .drawer__footer {
        flex-wrap: wrap;
        justify-content: center;
        gap: 10px;
        padding: 12px;
        border-top: 1px solid var(--border);
      }
    }
  </style>
</head>

<body>
  <!-- Sidebar -->
  <aside class="sidebar" id="sidebar">
    <div class="brand">
      <img src="https://raw.githubusercontent.com/Levinders/homeglitz/refs/heads/main/mainlogog-removebg-preview.png" alt="HomeGlitz Logo">
    </div>
    <ul class="nav-links">
      <li><a href="dashboard.html"><i class="fa-solid fa-chart-line"></i><span> Dashboard</span></a></li>
      <li class="nav-item open">
        <a href="#" id="bookingMenu"><i class="fa-solid fa-broom"></i><span> Bookings</span><i class="fa-solid fa-chevron-down" style="margin-left:auto;"></i></a>
        <div class="sub-menu" style="display:flex;">
          <a href="booking.html">Create New</a>
          <a href="all-bookings.html" class="active">All Bookings</a>
        </div>
      </li>
      <li><a href="properties.html"><i class="fa-solid fa-house"></i><span> Properties</span></a></li>
      <li><a href="cleaners.html"><i class="fa-solid fa-users"></i><span> Cleaners</span></a></li>
      <li><a href="reports.html"><i class="fa-solid fa-chart-pie"></i><span> Reports</span></a></li>
      <li><a href="settings.html"><i class="fa-solid fa-gear"></i><span> Settings</span></a></li>
    </ul>
  </aside>

  <div class="overlay" id="overlay"></div>

  <!-- Content -->
  <div style="flex:1; display:flex; flex-direction:column;">
    <header class="topbar">
      <button class="menu-toggle" id="menuToggle"><i class="fa-solid fa-bars"></i></button>
      <div class="topbar-right">
        <i class="fa-regular fa-bell"></i>
        <i class="fa-regular fa-user"></i>
      </div>
    </header>

    <main>
      <div class="card">
        <!-- Header (title + inline filters) -->
        <div class="card__header">

  <h2 class="card__title">
  <i class="fa-solid fa-list"></i> All Bookings
  <button id="btnRefresh" title="Refresh bookings" style="
    margin-left:auto;
    background: var(--primary);
    color: white;
    border: none;
    border-radius: 8px;
    padding: 8px 14px;
    font-size: 13px;
    font-weight: 600;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 6px;
    box-shadow: 0 4px 10px rgba(15,114,180,0.2);
    transition: 0.2s ease;
  ">
    <i class="fa-solid fa-rotate-right"></i> Refresh
  </button>
</h2>


            <div class="field" title="Search">
              <i class="fa-solid fa-magnifying-glass"></i>
              <input id="fSearch" type="text" placeholder="Search cleaner, property‚Ä¶"/>
            </div>
            <div class="field" title="Type">
              <i class="fa-solid fa-layer-group"></i>
              <select id="fType">
                <option value="all">All Types</option>
                <option value="airbnb">Airbnb Cleaning</option>
                <option value="office">Home / Office Cleaning</option>
              </select>
            </div>
            <div class="field" title="Status">
              <i class="fa-solid fa-flag"></i>
              <select id="fStatus">
                <option value="all">All Status</option>
                <option value="Pending">Pending</option>
                <option value="Clean Underway">Clean Underway</option>
                <option value="Completed">Completed</option>
              </select>
            </div>
            <div class="field" title="Date">
              <i class="fa-regular fa-calendar"></i>
              <input id="fDate" type="date"/>
            </div>
            <button class="btn-clear" id="fClear" title="Clear filters"><i class="fa-solid fa-rotate-left"></i></button>
          </div>
        </div>

        <!-- Table -->
        <div class="table-wrap">
          <table id="bookingsTable">
            <thead>
              <tr>
                <th>Booking ID</th>
                <th>Status</th>
                <th>Property Name</th>
                <th>Cleaner</th>                
                <th>Cleaning Date</th>
                <th>B2B</th>
                <th>Type</th>                
              </tr>
            </thead>
            <tbody>
              <tr><td colspan="7" style="text-align:center;color:var(--muted);padding:20px;">Loading bookings...</td></tr>
            </tbody>
          </table>
        </div>

        <!-- Fixed footer with pagination -->
        <div class="card__footer">
          <div class="page-indicator" id="pageIndicator">Page 1 of 1</div>
          <div class="pagination">
            <button class="btn" id="btnPrev"><i class="fa-solid fa-angle-left"></i> Prev</button>
            <button class="btn" id="btnNext">Next <i class="fa-solid fa-angle-right"></i></button>
          </div>
        </div>
      </div>
    </main>
  </div>

  <!-- Drawer -->
  <div class="drawer-overlay" id="drawerOverlay"></div>
  <aside class="drawer" id="drawer">
    <div class="drawer__head">
      <div class="drawer__title"><i class="fa-solid fa-clipboard-list"></i><span id="dwTitle">Booking Details</span></div>
      <button class="btn btn-light" id="dwClose"><i class="fa-solid fa-xmark"></i></button>
    </div>
    <div class="drawer__body">
      <div class="section-title"><i class="fa-solid fa-house"></i> Property</div>
      <div class="drawer__grid">
        <div class="group"><label><i class="fa-solid fa-hashtag"></i> Booking ID</label><input id="dwId" type="text" disabled></div>
        <div class="group"><label><i class="fa-solid fa-layer-group"></i> Type</label><input id="dwType" type="text" disabled></div>
        <div class="group"><label><i class="fa-solid fa-house-chimney"></i> Property Name</label><input id="dwProp" type="text" disabled></div>
        <div class="group"><label><i class="fa-solid fa-location-dot"></i> Address</label><input id="dwAddr" type="text" disabled></div>
      </div>

      <div class="section-title"><i class="fa-solid fa-user"></i> Cleaning</div>
      <div class="drawer__grid">
        <div class="group"><label><i class="fa-solid fa-user"></i> Cleaner</label><input id="dwCleaner" type="text"></div>
        <div class="group"><label><i class="fa-regular fa-calendar"></i> Cleaning Date</label><input id="dwDate" type="date"></div>
        <div class="group"><label><i class="fa-solid fa-flag"></i> Status</label>
          <select id="dwStatus">
            <option>Pending</option>
            <option>Clean Underway</option>
            <option>Completed</option>
          </select>
        </div>
        <div class="group"><label><i class="fa-solid fa-briefcase"></i> B2B</label>
          <div class="b2b-badges">
            <div class="badge" id="dwB2BYes">Yes</div>
            <div class="badge active" id="dwB2BNo">No</div>
          </div>
        </div>
      </div>

      <div class="group" style="margin-top:10px;">
        <label><i class="fa-regular fa-note-sticky"></i> Notes</label>
        <textarea id="dwNotes" rows="3" placeholder="Door code, supplies, special requests‚Ä¶"></textarea>
      </div>

      <div id="dwAirbnbSection" style="margin-top:16px; display:none;">
        <div class="section-title"><i class=""></i></div>
        <div id="dwLinenGrid" class="drawer__grid"></div>
      </div>
    </div>
    <div class="drawer__footer">
      <button class="btn btn-light" id="dwCancel">Cancel</button>
      <button class="btn btn-primary" id="dwSave"><i class="fa-solid fa-floppy-disk"></i> Save Changes</button>
    </div>
  </aside>

  <!-- Toast + Loader -->
  <div class="hz-toast" id="toast"></div>
  <div class="hz-loader" id="loader"><div class="box"><div class="spin"></div><span>Loading‚Ä¶</span></div></div>

  <script>
/* ===== Sidebar / Topbar ===== */
const sidebar = document.getElementById('sidebar');
const overlay = document.getElementById('overlay');
const menuToggle = document.getElementById('menuToggle');
const bookingMenu = document.getElementById('bookingMenu');
const bookingItem = bookingMenu.parentElement;

menuToggle.onclick = () => { sidebar.classList.toggle('open'); overlay.classList.toggle('active'); };
overlay.onclick = () => { sidebar.classList.remove('open'); overlay.classList.remove('active'); };
bookingMenu.onclick = (e) => { e.preventDefault(); bookingItem.classList.toggle('open'); };

/* ===== Toast + Loader ===== */
const toast = document.getElementById('toast');
const loader = document.getElementById('loader');
function showToast(msg){ toast.textContent = msg; toast.classList.add('show'); setTimeout(()=>toast.classList.remove('show'), 2200); }
function showLoader(){ loader.classList.add('active'); }
function hideLoader(){ loader.classList.remove('active'); }

/* ===== API base ===== */
const scriptBaseURL =
  "https://corsproxy.io/?" + encodeURIComponent("https://script.google.com/macros/s/AKfycbyqntrve2xWkoQLm__g-8o3p80wYM2Jc92X8YsV8K2si3iAcKlveyYIZhMtx6nT8gRK/exec");

async function fetchJSON(url) {
  const sep = url.includes("?") ? "&" : "?";
  const res = await fetch(`${url}${sep}_=${Date.now()}`, { cache: "no-store" });
  const text = await res.text();
  if (text.trim().startsWith("<")) throw new Error("Non-JSON response (HTML)");
  return JSON.parse(text);
}

/* ===== State ===== */
let ALL_ROWS = [];
let FILTERED = [];
const PAGE_SIZE = 25;
let page = 1;
let totalPages = 1;

/* ===== Load bookings ===== */
async function loadBookings() {
  showLoader();
  try {
    const rows = await fetchJSON(`${scriptBaseURL}?type=bookings`);
    ALL_ROWS = hydrateTypes(rows).sort(sortByMostRecent);
    applyFilters();
  } catch (e) {
    console.error(e);
    showToast('Error loading bookings');
    renderTable([]);
  } finally {
    hideLoader();
  }
}


const btnRefresh = document.getElementById('btnRefresh');
btnRefresh.addEventListener('click', async () => {
  showLoader(); // show the loader overlay
  try {
    await loadBookings(); // re-fetch and re-render table
    showToast('‚úÖ Bookings updated');
  } catch (err) {
    console.error(err);
    showToast('‚ö†Ô∏è Error refreshing');
  } finally {
    hideLoader(); // hide the loader again
  }
});


    
        // üëÇ Listen for new booking events from other tabs/pages
window.addEventListener('storage', async (e) => {
  if (e.key === 'refreshBookings') {
    showToast("üîÑ New booking detected! Refreshing‚Ä¶");
    await loadBookings();
  }
});

function hydrateTypes(rows) {
  return rows.map(r => {
    let type = r["Type"];
    if (!type) type = (typeof r["Flat Sheets King"] !== 'undefined') ? "Airbnb Cleaning" : "Home / Office Cleaning";
    return { ...r, Type: type };
  });
}

function sortByMostRecent(a, b) {
  const da = a["Cleaning Date"] ? new Date(a["Cleaning Date"]).getTime() : 0;
  const db = b["Cleaning Date"] ? new Date(b["Cleaning Date"]).getTime() : 0;
  if (db !== da) return db - da;
  const ta = a["Timestamp"] ? new Date(a["Timestamp"]).getTime() : 0;
  const tb = b["Timestamp"] ? new Date(b["Timestamp"]).getTime() : 0;
  if (tb !== ta) return tb - ta;
  const ia = (a["Booking ID"] || "").toString();
  const ib = (b["Booking ID"] || "").toString();
  return ib.localeCompare(ia);
}

/* ===== Filters ===== */
const fSearch = document.getElementById('fSearch');
const fType = document.getElementById('fType');
const fStatus = document.getElementById('fStatus');
const fDate = document.getElementById('fDate');
const fClear = document.getElementById('fClear');

function applyFilters() {
  const q = (fSearch.value || '').toLowerCase().trim();
  const t = fType.value;
  const s = fStatus.value;
  const exactDate = fDate.value ? new Date(fDate.value) : null;

  FILTERED = ALL_ROWS.filter(r => {
    const hay = [
      r["Booking ID"], r["Property Name"], r["Cleaners"], r["Address"], r["Notes"], r["Note"]
    ].map(x => (x || '').toString().toLowerCase()).join(' ');
    if (q && !hay.includes(q)) return false;

    const type = (r["Type"] || '').toLowerCase();
    if (t === 'airbnb' && !type.includes('airbnb')) return false;
    if (t === 'office' && type.includes('airbnb')) return false;

    if (s !== 'all' && r["Status"] !== s) return false;

    if (exactDate) {
      const d = r["Cleaning Date"] ? new Date(r["Cleaning Date"]) : null;
      if (!d) return false;
      if (!isSameDay(d, exactDate)) return false;
    }

    return true;
  });

  page = 1;
  paginateAndRender();
}

[fSearch, fType, fStatus, fDate].forEach(el => el.addEventListener('input', applyFilters));
fClear.addEventListener('click', () => {
  fSearch.value = ''; fType.value = 'all'; fStatus.value = 'all'; fDate.value = '';
  applyFilters();
});

function isSameDay(a,b){return a.getFullYear()===b.getFullYear()&&a.getMonth()===b.getMonth()&&a.getDate()===b.getDate();}

/* ===== Pagination ===== */
const btnPrev=document.getElementById('btnPrev');
const btnNext=document.getElementById('btnNext');
const pageIndicator=document.getElementById('pageIndicator');

btnPrev.onclick=()=>{if(page>1){page--;paginateAndRender();}};
btnNext.onclick=()=>{if(page<totalPages){page++;paginateAndRender();}};

function paginateAndRender(){
  const total=FILTERED.length;
  totalPages=Math.max(1,Math.ceil(total/PAGE_SIZE));
  if(page>totalPages)page=totalPages;
  const start=(page-1)*PAGE_SIZE;
  const slice=FILTERED.slice(start,start+PAGE_SIZE);
  renderTable(slice);
  pageIndicator.textContent=`Page ${page} of ${totalPages}`;
  btnPrev.disabled=(page<=1);
  btnNext.disabled=(page>=totalPages);
}

/* ===== Table Render ===== */
function renderTable(rows){
  const tbody=document.querySelector('#bookingsTable tbody');
  if(!rows||rows.length===0){
    tbody.innerHTML=`<tr><td colspan="7" style="text-align:center;color:var(--muted);padding:20px;">No bookings found</td></tr>`;
    return;
  }

  tbody.innerHTML=rows.map(r=>{
    const id=r["Booking ID"]||"";
    const propFull=r["Property Name"]||"";
    const propTrunc=truncateWords(propFull,3);
    const cleaner=r["Cleaners"]||"";
    const date=r["Cleaning Date"]?formatDateCell(r["Cleaning Date"]):"";
    const b2b=r["B2B"]||"";
    const type=r["Type"]||(r["Flat Sheets King"]?"Airbnb Cleaning":"Home / Office Cleaning");
    const status=r["Status"]||"Pending";
    return`
      <tr data-id="${escapeHtml(id)}" data-type="${escapeHtml(type)}">
        <td>${escapeHtml(id)}</td>
        <td class="cell-actions" onclick="event.stopPropagation();">
          <select class="status-select" data-id="${escapeHtml(id)}">
            ${["Pending","Clean Underway","Completed"].map(s=>`<option value="${s}" ${status===s?"selected":""}>${s}</option>`).join("")}
          </select>
        </td>
        <td title="${escapeHtml(propFull)}"><span class="prop-trunc">${escapeHtml(propTrunc)}</span></td>
        <td>${escapeHtml(cleaner)}</td>
        <td>${escapeHtml(date)}</td>
        <td>${escapeHtml(b2b)}</td>
        <td>${escapeHtml(type)}</td>
      </tr>`;
  }).join("");

  document.querySelectorAll('#bookingsTable tbody tr').forEach(tr=>{
    tr.addEventListener('click',()=>openDrawerWith(tr.dataset.id));
  });

  document.querySelectorAll('.status-select').forEach(sel=>{
    sel.addEventListener('change',async(e)=>{
      const bookingId=e.target.getAttribute('data-id');
      const newStatus=e.target.value;
      const row=e.target.closest('tr');
      await updateStatus(bookingId,newStatus,row);
    });
  });
}

function truncateWords(str,count){if(!str)return'';const parts=str.trim().split(/\s+/);return parts.length<=count?str:parts.slice(0,count).join(' ')+'‚Ä¶';}
function formatDateCell(v){try{const d=(typeof v==='string'||typeof v==='number')?new Date(v):v;return new Date(d).toLocaleDateString();}catch{return'';}}
function escapeHtml(s){return String(s??'').replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));}

/* ===== Inline Status Update ===== */
async function updateStatus(bookingId,status,rowEl){
  try{
    showLoader();
    await fetch(scriptBaseURL,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({action:'updateStatus',bookingId,status})});
    showToast('Status updated');
    rowEl.classList.add('flash');
    setTimeout(()=>rowEl.classList.remove('flash'),800);
  }catch(e){
    console.error(e);
    showToast('Error updating status');
  }finally{hideLoader();}
}

/* ===== Drawer ===== */
const drawer=document.getElementById('drawer');
const drawerOverlay=document.getElementById('drawerOverlay');
const dwClose=document.getElementById('dwClose');
const dwCancel=document.getElementById('dwCancel');
const dwSave=document.getElementById('dwSave');

const dwTitle=document.getElementById('dwTitle');
const dwId=document.getElementById('dwId');
const dwType=document.getElementById('dwType');
const dwProp=document.getElementById('dwProp');
const dwAddr=document.getElementById('dwAddr');
const dwCleaner=document.getElementById('dwCleaner');
const dwDate=document.getElementById('dwDate');
const dwStatus=document.getElementById('dwStatus');
const dwB2BYes=document.getElementById('dwB2BYes');
const dwB2BNo=document.getElementById('dwB2BNo');
const dwNotes=document.getElementById('dwNotes');
const dwAirbnbSection=document.getElementById('dwAirbnbSection');
const dwLinenGrid=document.getElementById('dwLinenGrid');

let CURRENT_EDIT=null;

function openDrawerWith(bookingId){
  const row=ALL_ROWS.find(r=>(r["Booking ID"]||'')===bookingId);
  if(!row)return;
  CURRENT_EDIT=JSON.parse(JSON.stringify(row));
  const type=row["Type"]||(row["Flat Sheets King"]?"Airbnb Cleaning":"Home / Office Cleaning");

  dwTitle.textContent=`Booking Details ‚Äî ${bookingId}`;
  dwId.value=row["Booking ID"]||'';
  dwType.value=type;
  dwProp.value=row["Property Name"]||'';
  dwAddr.value=row["Address"]||'';
  dwCleaner.value=row["Cleaners"]||'';
  dwDate.value=toDateInput(row["Cleaning Date"]);
  dwStatus.value=row["Status"]||'Pending';
  const b2b=(row["B2B"]||'No').toLowerCase();
  if(b2b==='yes'){dwB2BYes.classList.add('active');dwB2BNo.classList.remove('active');}else{dwB2BNo.classList.add('active');dwB2BYes.classList.remove('active');}
  dwNotes.value=row["Notes"]||row["Note"]||'';

  if(type.toLowerCase().includes('airbnb')){dwAirbnbSection.style.display='block';renderLinenInputs(row);}
  else{dwAirbnbSection.style.display='none';dwLinenGrid.innerHTML='';}

  drawer.classList.add('active');
  drawerOverlay.classList.add('active');
}

function toDateInput(v){if(!v)return'';const d=new Date(v);if(isNaN(d))return'';const yyyy=d.getFullYear();const mm=String(d.getMonth()+1).padStart(2,'0');const dd=String(d.getDate()).padStart(2,'0');return`${yyyy}-${mm}-${dd}`;}

/* ===== Load Price List (normalized keys) ===== */
let PRICE_LIST = {};

async function loadPriceList() {
  try {
    const data = await fetchJSON(`${scriptBaseURL}?type=price-list`);
    PRICE_LIST = {};

    (data || []).forEach(item => {
      const name = (item["Item"] || "").toString().trim().toLowerCase();
      const price = parseFloat(item["Pick-Up Price (Ex GST)"]) || 0;
      if (name) PRICE_LIST[name] = price;
    });

    console.log("‚úÖ Loaded Price List:", PRICE_LIST);
  } catch (err) {
    console.error("‚ùå Error loading price list:", err);
    PRICE_LIST = {};
  }
}

/* ===== Airbnb Packing List Renderer (fetch live totals from sheet) ===== */
async function renderLinenInputs(row) {
  const bookingId = row["Booking ID"];
  if (!bookingId) return;

  // Ensure Price List is loaded
  if (Object.keys(PRICE_LIST).length === 0) await loadPriceList();

  const section = document.getElementById("dwAirbnbSection");
  let dwPackingHeader = document.getElementById("dwPackingHeader");

  // Create header if not existing
  if (!dwPackingHeader) {
    dwPackingHeader = document.createElement("div");
    dwPackingHeader.id = "dwPackingHeader";
    dwPackingHeader.style.display = "flex";
    dwPackingHeader.style.alignItems = "center";
    dwPackingHeader.style.justifyContent = "space-between";
    dwPackingHeader.style.marginBottom = "10px";
    dwPackingHeader.innerHTML = `
      <div class="section-title" style="border-bottom:none;margin:0;">
        <i class="fa-solid fa-bed"></i> Packing List (Airbnb)
      </div>
      <div id="dwPackingTotal" style="font-weight:700;color:var(--primary);font-size:14px;">
        Total: Loading‚Ä¶
      </div>`;
    section.prepend(dwPackingHeader);
  }

  const dwPackingTotal = document.getElementById("dwPackingTotal");

  try {
    // üîπ Fetch live booking data from your "Airbnb Booking" sheet
    const bookingData = await fetchJSON(`${scriptBaseURL}?type=booking&id=${encodeURIComponent(bookingId)}`);

    if (!bookingData || !Array.isArray(bookingData) || bookingData.length === 0) {
      dwPackingTotal.textContent = "Total: $0.00";
      return;
    }

    // Your backend should return one row for that booking
    const liveRow = bookingData[0];

    const linenKeys = [
      "Flat Sheets King","Flat Sheets Queen","Flat Sheets Double","Flat Sheets Single",
      "Doona King","Doona Queen","Doona Double","Doona Single",
      "Pillowcases","Bath Towels","Hand Towels","Face Towels","Bathmats","Tea Towels",
      "King Fitted","Queen Fitted","Single Fitted"
    ];

    // Calculate total from sheet
    let total = 0;
    linenKeys.forEach(k => {
      const qty = parseFloat(liveRow[k] || 0);
      const price = PRICE_LIST[k.toLowerCase()] || 0;
      total += qty * price;
    });

    // Display total
    dwPackingTotal.textContent = `Total: $${total.toFixed(2)}`;

    // Populate the inputs visually (still show the packing list)
    dwLinenGrid.innerHTML = linenKeys.map(k => `
      <div class="group">
        <label><i class="fa-solid fa-box-open"></i> ${k}</label>
        <input type="number" min="0" step="1" data-linen="${k}" value="${Number(liveRow[k] || 0)}" disabled>
      </div>
    `).join("");

  } catch (err) {
    console.error("Error fetching live booking data:", err);
    dwPackingTotal.textContent = "Total: Error loading";
  }
}


/* ===== Drawer Controls ===== */
function closeDrawer(){drawer.classList.remove('active');drawerOverlay.classList.remove('active');CURRENT_EDIT=null;}
dwClose.onclick=closeDrawer;
dwCancel.onclick=closeDrawer;
drawerOverlay.onclick=closeDrawer;
dwB2BYes.onclick=()=>{dwB2BYes.classList.add('active');dwB2BNo.classList.remove('active');};
dwB2BNo.onclick=()=>{dwB2BNo.classList.add('active');dwB2BYes.classList.remove('active');};

/* ===== Save ===== */
dwSave.onclick=async()=>{
  if(!CURRENT_EDIT)return;
  const payload={
    action:'updateBooking',
    bookingId:dwId.value,
    cleaner:dwCleaner.value,
    date:dwDate.value,
    status:dwStatus.value,
    b2b:dwB2BYes.classList.contains('active')?'Yes':'No',
    notes:dwNotes.value,
    linen:{}
  };
  if(dwAirbnbSection.style.display!=='none'){
    dwLinenGrid.querySelectorAll('input[data-linen]').forEach(inp=>{
      const k=inp.getAttribute('data-linen');
      payload.linen[k]=Number(inp.value||0);
    });
  }
  try{
    showLoader();
    await fetch(scriptBaseURL,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)});
    showToast('Saved changes');
    await loadBookings();
    closeDrawer();
  }catch(e){console.error(e);showToast('Error saving changes');}finally{hideLoader();}
};

/* ===== INIT ===== */
(async()=>{await loadPriceList();await loadBookings();})();

    // üîÑ Auto-refresh bookings every 20 seconds (real-time feel)
setInterval(async () => {
  try {
    console.log("üîÅ Syncing bookings...");
    const oldCount = ALL_ROWS.length;
    await loadBookings();
    const newCount = ALL_ROWS.length;
    if (newCount !== oldCount) showToast("üîÑ Bookings updated");
  } catch (err) {
    console.warn("Sync error:", err);
  }
}, 1000); // every 20s


</script>

</body>
</html>
